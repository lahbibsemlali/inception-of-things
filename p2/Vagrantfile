Vagrant.configure("2") do |config|

  config.vm.define "abouzanbS" do |server|
    server.vm.box = "ubuntu/jammy64"
    server.vm.hostname = "abouzanbS"
    server.vm.network "private_network", ip: "192.168.56.110"
    
    server.vm.provider "virtualbox" do |vb|
      vb.gui = false 
      vb.memory = "1024"
      vb.cpus = 1
      vb.name = "abouzanbS"
    end

    server.vm.provision "file", source: "./deployment.yaml", destination: "/tmp/depl.yaml"
    server.vm.provision "file", source: "./services.yaml", destination: "/tmp/services.yaml"
    server.vm.provision "file", source: "./ingress.yaml", destination: "/tmp/ingres.yaml"

    server.vm.provision "shell", inline: <<-SHELL
      set -e 
      
      echo "=== Updating system ==="
      sudo apt-get update -qq
      
      echo "=== Installing K3s server ==="
      curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
      
      echo "=== Waiting for K3s to be ready ==="
      until sudo k3s kubectl get nodes 2>/dev/null; do
        echo "Waiting for k3s to start..."
        sleep 5
      done
      
      echo "=== Setting up kubeconfig ==="
      mkdir -p /home/vagrant/.kube
      sudo cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      sudo chown vagrant:vagrant /home/vagrant/.kube/config
      
      sudo k3s kubectl apply -f /tmp/depl.yaml
      
      echo "=== Applying services ==="
      sudo k3s kubectl apply -f /tmp/services.yaml
      
      echo "=== Applying ingress ==="
      sudo k3s kubectl apply -f /tmp/ingres.yaml
      
      echo "=== Waiting for pods to be ready ==="
      sudo k3s kubectl wait --for=condition=ready pod --all --timeout=300s || true
      
      echo "=== K3s Setup Complete ==="
      echo ""
      echo "Nodes:"
      sudo k3s kubectl get nodes
      echo ""
      echo "Pods:"
      sudo k3s kubectl get pods
      echo ""
      echo "Services:"
      sudo k3s kubectl get svc
      echo ""
      echo "Ingress:"
      sudo k3s kubectl get ingress


      echo "=== K3s server setup completed! ==="
    SHELL
  end

end